#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "myfs.h" // –ó–∞–≥–æ–ª–æ–≤–æ—á–Ω—ã–π —Ñ–∞–π–ª —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã

// –¶–≤–µ—Ç–æ–≤—ã–µ –∫–æ–¥—ã ANSI 
#define RESET   "\033[0m"
#define RED     "\033[31m"
#define GREEN   "\033[32m"
#define YELLOW  "\033[33m"
#define BLUE    "\033[34m"
#define CYAN    "\033[36m"
#define BOLD    "\033[1m"

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–µ–Ω—é —Å –∫–æ–º–∞–Ω–¥–∞–º–∏
void show_menu() {
    printf("\n%s========== %sMYFS –ú–ï–ù–Æ%s ==========%s\n", CYAN, BOLD, CYAN, RESET);
    printf("%s 1.%s üì¶ –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ/–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –§–°\n", GREEN, RESET);
    printf("%s 2.%s üìÑ –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª\n", GREEN, RESET);
    printf("%s 3.%s üìÇ –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤\n", GREEN, RESET);
    printf("%s 4.%s ‚ùå –£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª\n", GREEN, RESET);
    printf("%s 5.%s ‚úèÔ∏è  –ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å —Ñ–∞–π–ª\n", GREEN, RESET);
    printf("%s 6.%s ‚ûï –î–æ–∑–∞–ø–∏—Å–∞—Ç—å –≤ —Ñ–∞–π–ª\n", GREEN, RESET);
    printf("%s 7.%s üìñ –ü—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª\n", GREEN, RESET);
    printf("%s 8.%s ‚ÑπÔ∏è  –û–ø–∏—Å–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥\n", GREEN, RESET);
    printf("%s 0.%s üö™ –í—ã—Ö–æ–¥\n", RED, RESET);
    printf("%s–í—ã–±–æ—Ä:%s ", BOLD, RESET);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–ø—Ä–∞–≤–∫–∏ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º
void show_help() {
    printf("\n%s–û–ü–ò–°–ê–ù–ò–ï –ö–û–ú–ê–ù–î:%s\n", CYAN, RESET);
    printf("1. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ/–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ‚Äî —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—É—é —Ñ–∞–π–ª–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É –Ω–∞ 'disk.img'\n");
    printf("2. –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª ‚Äî –¥–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–π –ø—É—Å—Ç–æ–π —Ñ–∞–π–ª\n");
    printf("3. –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–∞–π–ª—ã ‚Äî –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–µ\n");
    printf("4. –£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª ‚Äî —É–¥–∞–ª—è–µ—Ç —Ñ–∞–π–ª –∏ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –±–ª–æ–∫–∏\n");
    printf("5. –ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å —Ñ–∞–π–ª ‚Äî —É–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –Ω–æ–≤–æ–µ\n");
    printf("6. –î–æ–∑–∞–ø–∏—Å–∞—Ç—å ‚Äî –¥–æ–±–∞–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç –≤ –∫–æ–Ω–µ—Ü —Ñ–∞–π–ª–∞\n");
    printf("7. –ü—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª ‚Äî –≤—ã–≤–æ–¥–∏—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞\n");
    printf("8. –û–ø–∏—Å–∞–Ω–∏–µ ‚Äî –≤—ã–≤–æ–¥–∏—Ç —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É\n");
    printf("0. –í—ã—Ö–æ–¥ ‚Äî –∑–∞–≤–µ—Ä—à–∞–µ—Ç –ø—Ä–æ–≥—Ä–∞–º–º—É\n");
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —á—Ç–µ–Ω–∏—è –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–æ Ctrl+D / Ctrl+Z)
char* read_multiline_input() {
    printf("–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ (–∑–∞–≤–µ—Ä—à–∏—Ç–µ Ctrl+D –∏–ª–∏ Ctrl+Z):\n\n");

    size_t size = 1024;           // –Ω–∞—á–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –±—É—Ñ–µ—Ä–∞
    size_t len = 0;               // —Ç–µ–∫—É—â–∞—è –¥–ª–∏–Ω–∞ —Å—Ç—Ä–æ–∫–∏
    char* buffer = malloc(size);  // –≤—ã–¥–µ–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏
    if (!buffer) return NULL;

    int c;
    while ((c = getchar()) != EOF) {
        if (len + 1 >= size) {                // –µ—Å–ª–∏ –±—É—Ñ–µ—Ä –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω
            size *= 2;                        // —É–≤–µ–ª–∏—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä –±—É—Ñ–µ—Ä–∞
            buffer = realloc(buffer, size);   // –ø–µ—Ä–µ–≤—ã–¥–µ–ª–∏—Ç—å –ø–∞–º—è—Ç—å
            if (!buffer) return NULL;
        }
        buffer[len++] = (char)c;              // –¥–æ–±–∞–≤–∏—Ç—å —Å–∏–º–≤–æ–ª –≤ –±—É—Ñ–µ—Ä
    }
    buffer[len] = '\0';                       // –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏
    return buffer;
}

// –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≥—Ä–∞–º–º—ã
int main() {
    const char* fs_name = "disk.img"; // –∏–º—è —Ñ–∞–π–ª–∞, –≤ –∫–æ—Ç–æ—Ä–æ–º —Ö—Ä–∞–Ω–∏—Ç—Å—è —Ñ–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞
    FILE* fs = NULL; // –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä –æ—Ç–∫—Ä—ã—Ç–æ–π —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ñ–∞–π–ª–∞ –§–°, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏
    FILE* test = fopen(fs_name, "rb");
    if (!test) {
        printf("%s[–ò–ù–§–û]%s –§–∞–π–ª –§–° –Ω–µ –Ω–∞–π–¥–µ–Ω. –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...\n", YELLOW, RESET);
        if (!format_fs(fs_name)) {
            fprintf(stderr, "%s[–û–®–ò–ë–ö–ê]%s –ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –§–°\n", RED, RESET);
            return 1;
        }
        printf("%s[–û–ö]%s –§–° —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞\n", GREEN, RESET);
    }
    else {
        fclose(test);
    }

    int choice;                 // –≤—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –º–µ–Ω—é
    char filename[256];         // –∏–º—è —Ñ–∞–π–ª–∞, –≤–≤–æ–¥–∏–º–æ–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º

    // –ì–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª –ø—Ä–æ–≥—Ä–∞–º–º—ã ‚Äî –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∫–æ–º–∞–Ω–¥
    while (1) {
        show_menu();

        if (scanf("%d", &choice) != 1) {  // —á—Ç–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞
            printf("–û—à–∏–±–∫–∞ –≤–≤–æ–¥–∞\n");
            while (getchar() != '\n');    // –æ—á–∏—Å—Ç–∫–∞ –≤–≤–æ–¥–∞
            continue;
        }
        getchar(); // —É–¥–∞–ª–µ–Ω–∏–µ —Å–∏–º–≤–æ–ª–∞ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏ –ø–æ—Å–ª–µ —á–∏—Å–ª–∞
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥
        switch (choice) {
        case 1:
            // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –§–°
            if (format_fs(fs_name)) {
                printf("%s[–û–ö]%s –§–° —É—Å–ø–µ—à–Ω–æ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∞ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞\n", GREEN, RESET);
            }
            else {
                printf("%s[–û–®–ò–ë–ö–ê]%s –û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è\n", RED, RESET);
            }
            break;

        case 2:
            // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞
            if (!fs) fs = open_fs(fs_name);
            if (fs) {
                printf("–ò–º—è —Ñ–∞–π–ª–∞: ");
                fgets(filename, sizeof(filename), stdin);
                filename[strcspn(filename, "\n")] = '\0'; // —É–¥–∞–ª–µ–Ω–∏–µ \n
                if (create_file(fs, filename) >= 0) {
                    printf("–§–∞–π–ª —Å–æ–∑–¥–∞–Ω\n");
                }
                else {
                    printf("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∞–π–ª–∞\n");
                }
            }
            break;

        case 3:
            // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤
            if (!fs) fs = open_fs(fs_name);
            if (fs) list_files(fs);
            break;

        case 4:
            // –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
            if (!fs) fs = open_fs(fs_name);
            if (fs) {
                printf("–ò–º—è —Ñ–∞–π–ª–∞: ");
                fgets(filename, sizeof(filename), stdin);
                filename[strcspn(filename, "\n")] = '\0';
                if (delete_file(fs, filename)) {
                    printf("–§–∞–π–ª —É–¥–∞–ª—ë–Ω\n");
                }
                else {
                    printf("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è\n");
                }
            }
            break;

        case 5:
            // –ü–µ—Ä–µ–∑–∞–ø–∏—Å—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Ñ–∞–π–ª–∞
            if (!fs) fs = open_fs(fs_name);
            if (fs) {
                printf("–ò–º—è —Ñ–∞–π–ª–∞: ");
                fgets(filename, sizeof(filename), stdin);
                filename[strcspn(filename, "\n")] = '\0';

                getchar();
                char* data = read_multiline_input();
                if (!data) {
                    printf("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö\n");
                    break;
                }

                if (write_file(fs, filename, data)) {
                    printf("\n–ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–∞\n");
                }
                else {
                    printf("\n–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏\n");
                }
                free(data);
            }
            break;

        case 6:
            // –î–æ–∑–∞–ø–∏—Å—å –≤ —Ñ–∞–π–ª
            if (!fs) fs = open_fs(fs_name);
            if (fs) {
                printf("–ò–º—è —Ñ–∞–π–ª–∞: ");
                fgets(filename, sizeof(filename), stdin);
                filename[strcspn(filename, "\n")] = '\0';

                getchar();
                char* data = read_multiline_input();
                if (!data) {
                    printf("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö\n");
                    break;
                }

                if (write_file1(fs, filename, data)) {
                    printf("\n–ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–∞\n");
                }
                else {
                    printf("\n–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏\n");
                }
                free(data);
            }
            break;

        case 7:
            // –ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
            if (!fs) fs = open_fs(fs_name);
            if (fs) {
                printf("–ò–º—è —Ñ–∞–π–ª–∞: ");
                fgets(filename, sizeof(filename), stdin);
                filename[strcspn(filename, "\n")] = '\0';

                char buffer[1024];
                if (read_file(fs, filename, buffer, sizeof(buffer))) {
                    printf("–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞:\n%s\n", buffer);
                }
                else {
                    printf("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è\n");
                }
            }
            break;

        case 8:
            // –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É
            show_help();
            break;
        case 0:
            // –í—ã—Ö–æ–¥
            if (fs) close_fs(fs);
            printf("%s–î–æ —Å–≤–∏–¥–∞–Ω–∏—è!%s\n", CYAN, RESET);
            return 0;

        default:
            printf("%s–ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É.%s\n", RED, RESET);
        }

        clearerr(stdin); // –æ—á–∏—Å—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø–æ—Ç–æ–∫–∞
    }
}